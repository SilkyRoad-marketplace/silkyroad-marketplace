<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Marketplace â€“ Silky Road</title>
  <link rel="icon" href="/favicon.png">
  <link rel="stylesheet" href="css/styles.css">

  <!-- Supabase JS v2 -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body class="marketplace-page">

  <!-- =========================
       SILKY ROAD MARKETPLACE HEADER (2 ROWS)
  ========================== -->
  <header class="sr-header">
    <div class="sr-container">
      <div class="sr-header-inner">
        <!-- Left: Logo -->
        <a href="/index.html" class="logo-link">
          <img src="/logo.png" alt="Silky Road" class="logo-img">
        </a>

        <!-- Center: Search products -->
        <div class="market-search">
          <input id="market-search-input" type="text" placeholder="Search products...">
        </div>

        <!-- Right: Actions (login / start selling OR library / dashboard) -->
        <div class="nav-actions nav-actions-market">
          <a href="/login.html" class="btn btn-ghost" id="btn-login">Login</a>
          <a href="/signup.html" class="btn btn-primary" id="btn-start-selling">Start selling</a>

          <a href="/library.html" class="btn btn-ghost" id="btn-library" style="display:none;">Library</a>
          <a href="/dashboard.html" class="btn btn-ghost" id="btn-dashboard" style="display:none;">Dashboard</a>

          <a href="/checkout.html" class="cart-link">
            <span class="cart-icon">ðŸ›’</span>
          </a>
        </div>

        <!-- Mobile menu toggle -->
        <button class="nav-toggle" id="nav-toggle" aria-label="Toggle navigation">
          <span></span><span></span><span></span>
        </button>
      </div>

      <!-- Mobile panel (simple for now) -->
      <div class="nav-mobile-panel" id="nav-mobile-panel">
        <div class="nav-mobile-section">
          <strong>Account</strong>
          <a href="/login.html" class="nav-link nav-link-small">Login</a>
          <a href="/signup.html" class="nav-link nav-link-small">Start selling</a>
          <a href="/library.html" class="nav-link nav-link-small">Library</a>
          <a href="/dashboard.html" class="nav-link nav-link-small">Dashboard</a>
        </div>
      </div>
    </div>

    <!-- Row 2: Category nav (Payhip style, scrollable on mobile) -->
    <nav class="marketplace-nav">
      <div class="sr-container">
        <div class="marketplace-nav-inner">
          <div class="nav-scroll">
            <a href="/marketplace" class="nav-pill" data-cat="all">All</a>
            <a href="/marketplace/3d" class="nav-pill" data-cat="3d">3D</a>
            <a href="/marketplace/roblox" class="nav-pill" data-cat="roblox">Roblox</a>
            <a href="/marketplace/crafts" class="nav-pill" data-cat="crafts">Crafts</a>
            <a href="/marketplace/design" class="nav-pill" data-cat="design">Design</a>
            <a href="/marketplace/drawing-and-painting" class="nav-pill" data-cat="drawing-and-painting">Drawing &amp; Painting</a>
            <a href="/marketplace/music-and-sound-design" class="nav-pill" data-cat="music-and-sound-design">Music &amp; Sound Design</a>
            <a href="/marketplace/films" class="nav-pill" data-cat="films">Films</a>

            <!-- More â–¾ with subcategories -->
            <div class="nav-more">
              <button class="nav-pill">More â–¾</button>
              <div class="nav-more-dropdown">
                <div class="more-group">
                  <div class="more-group-title">Fiction Books</div>
                  <a class="more-link" href="/marketplace/fiction-books/mystery">Mystery</a>
                  <a class="more-link" href="/marketplace/fiction-books/thriller">Thriller</a>
                  <a class="more-link" href="/marketplace/fiction-books/romance">Romance</a>
                  <a class="more-link" href="/marketplace/fiction-books/fantasy">Fantasy</a>
                </div>

                <div class="more-group">
                  <div class="more-group-title">Business &amp; Money</div>
                  <a class="more-link" href="/marketplace/business-and-money/investing">Investing</a>
                  <a class="more-link" href="/marketplace/business-and-money/personal-finance">Personal Finance</a>
                  <a class="more-link" href="/marketplace/business-and-money/entrepreneurship">Entrepreneurship</a>
                </div>

                <div class="more-group">
                  <div class="more-group-title">Education</div>
                  <a class="more-link" href="/marketplace/education/ebooks">eBooks</a>
                  <a class="more-link" href="/marketplace/education/worksheets">Worksheets</a>
                  <a class="more-link" href="/marketplace/education/online-courses">Online Courses</a>
                </div>

                <!-- Add more groups if you want -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </nav>
  </header>

  <!-- =========================
       MAIN MARKETPLACE CONTENT
  ========================== -->
  <main class="page marketplace-page">
    <div class="marketplace-layout">

      <!-- LEFT: FILTERS -->
      <aside class="filters-column">
        <div class="filters-title-main">Filters</div>

        <!-- Tags -->
        <div class="filters-block">
          <div class="filters-block-title">Tags</div>
          <button class="filter-tag" data-tag="vrchat">vrchat</button>
          <button class="filter-tag" data-tag="notion template">notion template</button>
          <button class="filter-tag" data-tag="vrchat asset">vrchat asset</button>
          <button class="filter-tag" data-tag="free">free</button>
          <button class="filter-tag" data-tag="blender">blender</button>
          <button class="filter-tag" data-tag="" id="tags-show-more">Show more</button>
        </div>

        <!-- File types -->
        <div class="filters-block">
          <div class="filters-block-title">Contains</div>
          <button class="filter-filetype" data-type="pdf">pdf</button>
          <button class="filter-filetype" data-type="zip">zip</button>
          <button class="filter-filetype" data-type="mp4">mp4</button>
          <button class="filter-filetype" data-type="rar">rar</button>
          <button class="filter-filetype" data-type="mp3">mp3</button>
        </div>

        <!-- Price -->
        <div class="filters-block">
          <div class="filters-block-title">Price</div>
          <div class="filters-input-row">
            <label for="price-min">Minimum price</label>
            <input id="price-min" type="number" min="0" step="0.01" placeholder="0">
          </div>
          <div class="filters-input-row">
            <label for="price-max">Maximum price</label>
            <input id="price-max" type="number" min="0" step="0.01" placeholder="âˆž">
          </div>
        </div>

        <!-- Rating -->
        <div class="filters-block filters-rating">
          <div class="filters-block-title">Rating</div>
          <label><input type="radio" name="rating-min" value="4"> â˜…â˜…â˜…â˜…â˜† and up</label>
          <label><input type="radio" name="rating-min" value="3"> â˜…â˜…â˜…â˜†â˜† and up</label>
          <label><input type="radio" name="rating-min" value="2"> â˜…â˜…â˜†â˜†â˜† and up</label>
          <label><input type="radio" name="rating-min" value="1"> â˜…â˜†â˜†â˜†â˜† and up</label>
          <label><input type="radio" name="rating-min" value=""> Any rating</label>
        </div>

        <!-- Clear filters -->
        <div class="filters-footer">
          <button class="filters-clear-btn" id="filters-clear">Clear filters</button>
        </div>
      </aside>

      <!-- RIGHT: FEATURED + PRODUCTS -->
      <div class="marketplace-main">

        <!-- Featured slider -->
        <section class="featured-section" id="featured-section">
          <div class="featured-header">
            <div class="featured-title" id="featured-title">Featured products</div>
            <div class="featured-controls">
              <button class="featured-btn" data-dir="left">â€¹</button>
              <button class="featured-btn" data-dir="right">â€º</button>
            </div>
          </div>
          <div class="featured-track" id="featured-track"></div>
          <div class="empty-text" id="featured-empty" style="display:none;">
            No featured products yet.
          </div>
        </section>

        <!-- Products grid -->
        <section class="products-section">
          <div class="products-header">
            <div class="products-title" id="products-title">All products</div>
          </div>
          <div class="products-grid" id="products-grid"></div>
          <div class="empty-text" id="products-empty" style="display:none;">
            No products found in this category yet.
          </div>
        </section>
      </div>
    </div>
  </main>

  <!-- =========================
       MARKETPLACE SCRIPT
  ========================== -->
  <script>
    const SUPABASE_URL = "https://paqvgsruppgadgguynde.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBhcXZnc3J1cHBnYWRnZ3V5bmRlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzNTg3NTMsImV4cCI6MjA3NzkzNDc1M30.pwEE4WLFu2-tHkmH1fFYYwcEPmLPyavN7ykXdPGQ3AY";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const filterState = {
      tag: null,
      fileType: null,
      priceMin: null,
      priceMax: null,
      ratingMin: null,
      search: ""
    };

    function getCategoryFromUrl() {
      const path = window.location.pathname;
      const segments = path.split("/").filter(Boolean);
      let catSlug = null;
      let subSlug = null;
      const idx = segments.indexOf("marketplace");
      if (idx !== -1) {
        catSlug = segments[idx + 1] || null;
        subSlug = segments[idx + 2] || null;
      }
      const params = new URLSearchParams(window.location.search);
      const qCat = params.get("cat");
      const qSub = params.get("sub");
      if (!catSlug && qCat) catSlug = qCat;
      if (!subSlug && qSub) subSlug = qSub;
      if (catSlug === "all") catSlug = null;
      return { catSlug, subSlug };
    }

    function unslug(text) {
      if (!text) return "";
      return text
        .replace(/-/g, " ")
        .replace(/\b\w/g, c => c.toUpperCase());
    }

    function formatHeading(catSlug, subSlug) {
      if (!catSlug && !subSlug) return "All products";
      if (catSlug && !subSlug) return unslug(catSlug);
      if (catSlug && subSlug) return unslug(catSlug) + " / " + unslug(subSlug);
      return "Products";
    }

    function updateNavActive(catSlug) {
      const pills = document.querySelectorAll(".nav-pill[data-cat]");
      pills.forEach(pill => {
        const pillCat = pill.getAttribute("data-cat");
        if ((!catSlug && pillCat === "all") || (catSlug && pillCat === catSlug)) {
          pill.classList.add("active");
        } else {
          pill.classList.remove("active");
        }
      });
    }

    function formatSellerDisplay(name, plan) {
      if (!name) name = "Unknown seller";
      if (plan === "PRO") {
        return `${name} <span class="seller-badge-pro">[ â˜… PRO ]</span>`;
      }
      if (plan === "ULTIMATE") {
        return `${name} <span class="seller-badge-ultimate">[ ðŸ‘‘ ULTIMATE ]</span>`;
      }
      return name;
    }

    function buildRatingHtml(avg, count) {
      if (!avg || !count || count <= 0) return "";
      const score = Number(avg).toFixed(1);
      return `
        <div class="product-rating">
          <span class="star">â˜…</span>
          <span>${score}</span>
          <span>(${count})</span>
        </div>
      `;
    }

    function formatPrice(price) {
      if (typeof price === "number") return "US$" + price.toFixed(2);
      if (price === null || price === undefined) return "US$0.00";
      const n = Number(price);
      if (isNaN(n)) return "US$0.00";
      return "US$" + n.toFixed(2);
    }

    function buildProductCard(product) {
      const ratingHtml = buildRatingHtml(product.rating_avg, product.rating_count);
      const sellerHtml = formatSellerDisplay(product.seller_name, product.seller_plan);
      const priceText = formatPrice(product.price);
      const cover = product.cover_url || "/placeholder-product.png";
      const productUrl = `/product/${product.slug || product.id}`;
      return `
        <a href="${productUrl}" class="product-card">
          <div class="product-thumb">
            <img src="${cover}" alt="${product.title || "Product"}">
          </div>
          <div class="product-body">
            <div class="product-title">${product.title || "Untitled product"}</div>
            <div class="product-seller">${sellerHtml}</div>
            ${ratingHtml}
            <div class="product-footer">
              <div class="product-price">${priceText}</div>
              <div class="product-cta">View</div>
            </div>
          </div>
        </a>
      `;
    }

    function buildFeaturedCard(product) {
      const priceText = formatPrice(product.price);
      const sellerHtml = formatSellerDisplay(product.seller_name, product.seller_plan);
      const cover = product.cover_url || "/placeholder-product.png";
      const productUrl = `/product/${product.slug || product.id}`;
      return `
        <a href="${productUrl}" class="featured-card">
          <div class="featured-thumb">
            <img src="${cover}" alt="${product.title || "Product"}">
          </div>
          <div class="featured-body">
            <div class="featured-title-text">${product.title || "Untitled product"}</div>
            <div class="featured-meta">${sellerHtml}</div>
            <div class="featured-price">${priceText}</div>
          </div>
        </a>
      `;
    }

    function applyFiltersToQuery(query) {
      if (filterState.tag) {
        query = query.contains("tags", [filterState.tag]);
      }
      if (filterState.fileType) {
        query = query.contains("file_types", [filterState.fileType]);
      }
      if (filterState.priceMin !== null && filterState.priceMin !== "") {
        query = query.gte("price", filterState.priceMin);
      }
      if (filterState.priceMax !== null && filterState.priceMax !== "") {
        query = query.lte("price", filterState.priceMax);
      }
      if (filterState.ratingMin !== null && filterState.ratingMin !== "") {
        query = query.gte("rating_avg", filterState.ratingMin);
      }
      if (filterState.search) {
        query = query.ilike("title", "%" + filterState.search + "%");
      }
      return query;
    }

    async function loadFeaturedProducts(catSlug, subSlug) {
      const track = document.getElementById("featured-track");
      const empty = document.getElementById("featured-empty");
      track.innerHTML = "";
      empty.style.display = "none";

      let query = supabase
        .from("products")
        .select("id, slug, title, price, cover_url, seller_name, seller_plan, rating_avg, rating_count, category_slug, subcategory_slug, is_featured, is_active")
        .eq("is_active", true)
        .eq("is_featured", true)
        .limit(10);

      if (catSlug) query = query.eq("category_slug", catSlug);
      if (subSlug) query = query.eq("subcategory_slug", subSlug);

      query = applyFiltersToQuery(query);

      const { data, error } = await query;
      if (error) {
        console.error("Error loading featured products", error);
        empty.textContent = "Failed to load featured products.";
        empty.style.display = "block";
        return;
      }

      if (!data || data.length === 0) {
        empty.style.display = "block";
        return;
      }

      data.forEach(p => {
        track.insertAdjacentHTML("beforeend", buildFeaturedCard(p));
      });
    }

    async function loadProductsGrid(catSlug, subSlug) {
      const grid = document.getElementById("products-grid");
      const empty = document.getElementById("products-empty");
      grid.innerHTML = "";
      empty.style.display = "none";

      let query = supabase
        .from("products")
        .select("id, slug, title, price, cover_url, seller_name, seller_plan, rating_avg, rating_count, category_slug, subcategory_slug, is_active")
        .eq("is_active", true);

      if (catSlug) query = query.eq("category_slug", catSlug);
      if (subSlug) query = query.eq("subcategory_slug", subSlug);

      query = applyFiltersToQuery(query);

      const { data, error } = await query;
      if (error) {
        console.error("Error loading products", error);
        empty.textContent = "Failed to load products.";
        empty.style.display = "block";
        return;
      }

      if (!data || data.length === 0) {
        empty.style.display = "block";
        return;
      }

      data.forEach(p => {
        grid.insertAdjacentHTML("beforeend", buildProductCard(p));
      });
    }

    function initFeaturedSlider() {
      const track = document.getElementById("featured-track");
      if (!track) return;
      const buttons = document.querySelectorAll(".featured-btn");
      buttons.forEach(btn => {
        btn.addEventListener("click", () => {
          const dir = btn.getAttribute("data-dir");
          const amount = 220;
          track.scrollBy({
            left: dir === "left" ? -amount : amount,
            behavior: "smooth"
          });
        });
      });
    }

    function initFilterEvents(reloadFn) {
      document.querySelectorAll(".filter-tag").forEach(btn => {
        btn.addEventListener("click", () => {
          const tag = btn.getAttribute("data-tag");
          if (!tag) return;
          if (filterState.tag === tag) {
            filterState.tag = null;
            btn.classList.remove("active");
          } else {
            filterState.tag = tag;
            document.querySelectorAll(".filter-tag").forEach(b => b.classList.remove("active"));
            btn.classList.add("active");
          }
          reloadFn();
        });
      });

      document.querySelectorAll(".filter-filetype").forEach(btn => {
        btn.addEventListener("click", () => {
          const t = btn.getAttribute("data-type");
          if (filterState.fileType === t) {
            filterState.fileType = null;
            btn.classList.remove("active");
          } else {
            filterState.fileType = t;
            document.querySelectorAll(".filter-filetype").forEach(b => b.classList.remove("active"));
            btn.classList.add("active");
          }
          reloadFn();
        });
      });

      const priceMinInput = document.getElementById("price-min");
      const priceMaxInput = document.getElementById("price-max");
      priceMinInput.addEventListener("change", () => {
        filterState.priceMin = priceMinInput.value !== "" ? parseFloat(priceMinInput.value) : null;
        reloadFn();
      });
      priceMaxInput.addEventListener("change", () => {
        filterState.priceMax = priceMaxInput.value !== "" ? parseFloat(priceMaxInput.value) : null;
        reloadFn();
      });

      document.querySelectorAll("input[name='rating-min']").forEach(radio => {
        radio.addEventListener("change", () => {
          const v = radio.value;
          filterState.ratingMin = v === "" ? null : parseFloat(v);
          reloadFn();
        });
      });

      document.getElementById("filters-clear").addEventListener("click", () => {
        filterState.tag = null;
        filterState.fileType = null;
        filterState.priceMin = null;
        filterState.priceMax = null;
        filterState.ratingMin = null;
        filterState.search = "";
        document.querySelectorAll(".filter-tag, .filter-filetype").forEach(b => b.classList.remove("active"));
        priceMinInput.value = "";
        priceMaxInput.value = "";
        document.querySelectorAll("input[name='rating-min']").forEach(r => r.checked = false);
        const searchInput = document.getElementById("market-search-input");
        if (searchInput) searchInput.value = "";
        reloadFn();
      });

      const searchInput = document.getElementById("market-search-input");
      if (searchInput) {
        searchInput.addEventListener("input", () => {
          filterState.search = searchInput.value.trim();
          reloadFn();
        });
      }
    }

    async function initHeaderAuth() {
      try {
        const { data, error } = await supabase.auth.getUser();
        if (error) {
          console.warn("Auth check error", error);
          return;
        }
        const user = data?.user;
        const btnLogin = document.getElementById("btn-login");
        const btnStart = document.getElementById("btn-start-selling");
        const btnLib = document.getElementById("btn-library");
        const btnDash = document.getElementById("btn-dashboard");
        if (user) {
          if (btnLogin) btnLogin.style.display = "none";
          if (btnStart) btnStart.style.display = "none";
          if (btnLib) btnLib.style.display = "inline-flex";
          if (btnDash) btnDash.style.display = "inline-flex";
        } else {
          if (btnLogin) btnLogin.style.display = "inline-flex";
          if (btnStart) btnStart.style.display = "inline-flex";
          if (btnLib) btnLib.style.display = "none";
          if (btnDash) btnDash.style.display = "none";
        }
      } catch (e) {
        console.error("initHeaderAuth error", e);
      }
    }

    function initMobileNavToggle() {
      const toggle = document.getElementById("nav-toggle");
      const panel = document.getElementById("nav-mobile-panel");
      if (!toggle || !panel) return;
      toggle.addEventListener("click", () => {
        panel.classList.toggle("open");
      });
    }

    async function initMarketplace() {
      const { catSlug, subSlug } = getCategoryFromUrl();
      const heading = formatHeading(catSlug, subSlug);
      document.getElementById("products-title").textContent = heading;
      if (catSlug || subSlug) {
        document.getElementById("featured-title").textContent = "Featured in " + heading;
      } else {
        document.getElementById("featured-title").textContent = "Featured products";
      }
      updateNavActive(catSlug);
      initFeaturedSlider();

      const reloadAll = () => {
        loadFeaturedProducts(catSlug, subSlug);
        loadProductsGrid(catSlug, subSlug);
      };

      initFilterEvents(reloadAll);
      reloadAll();
    }

    document.addEventListener("DOMContentLoaded", () => {
      initHeaderAuth();
      initMobileNavToggle();
      initMarketplace();
    });
  </script>

</body>
</html>
