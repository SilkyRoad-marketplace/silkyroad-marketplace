<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Marketplace ‚Äì Silky Road</title>
  <link rel="icon" href="/favicon.png">
  <link rel="stylesheet" href="/css/styles.css">

  <!-- Supabase JS -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body class="marketplace-page">

  <!-- MARKETPLACE HEADER (SEPARATE FROM header-main) -->
  <header class="sr-header sr-header-marketplace">
    <div class="sr-header-inner">

      <!-- ROW 1: logo + search + actions -->
      <div class="sr-header-row1">
        <div class="sr-logo-wrap">
          <a href="/index.html" class="sr-logo-link">
            <img src="/logo.png" alt="Silky Road" class="sr-logo-img">
          </a>
        </div>

        <div class="sr-search-wrap">
  <form class="sr-search-form" action="/marketplace.html" method="get">
    <span class="sr-search-icon-inline">üîç</span>
    <input
      type="text"
      name="q"
      class="sr-search-input"
      placeholder="Search digital products..."
      aria-label="Search products"
    >
    <button type="button" class="sr-search-clear" aria-label="Clear search">‚úï</button>
  </form>
</div>

        <div class="sr-header-actions">
          <!-- logged-out -->
          <a href="/login.html" class="sr-header-link" data-role="login-link">Login</a>
          <a href="/sign_up.html" class="sr-header-btn sr-header-btn-gold" data-role="start-link">
            Start selling
          </a>

          <!-- logged-in -->
          <a href="/library.html" class="sr-header-link" data-role="library-link" style="display:none;">Library</a>
          <a href="/dashboard.html" class="sr-header-btn sr-header-btn-gold" data-role="dashboard-link" style="display:none;">
            Dashboard
          </a>

          <!-- cart -->
          <button type="button" class="sr-icon-btn sr-cart-btn" aria-label="Cart" data-role="cart-button">
            üõí
            <span class="cart-count-badge" data-role="cart-count" style="display:none;"></span>
          </button>
        </div>

        <!-- mobile-only hamburger -->
        <button class="sr-menu-btn" aria-label="Open navigation" id="nav-drawer-toggle">
          ‚ò∞
        </button>
      </div>
    </div>
  </header>
  <!-- DESKTOP CATEGORY BAR (supabase powered) -->
  <div class="marketplace-nav">
    <div class="sr-container">
      <div class="sr-category-scroll" id="desktop-cat-scroll"></div>
    </div>
  </div>
  
  <!-- MOBILE NAV DRAWER -->
  <div class="sr-drawer-backdrop" id="nav-drawer-backdrop">
    <aside class="sr-drawer" id="nav-drawer">
      <div class="sr-drawer-header">
        <button class="sr-drawer-close" type="button" id="nav-drawer-close">‚úï</button>
        <div class="sr-drawer-title" id="nav-drawer-title">Browse categories</div>
      </div>

      <div class="sr-drawer-body">
        <!-- Account actions (login / start OR library / dashboard) -->
        <div class="drawer-section drawer-account">
          <a href="/login.html" class="sr-header-link" data-role="login-link">Login</a>
          <a href="/sign_up.html" class="sr-header-btn sr-header-btn-gold" data-role="start-link">
            Start selling
          </a>
          <a href="/library.html" class="sr-header-link" data-role="library-link" style="display:none;">
            Library
          </a>
          <a href="/dashboard.html" class="sr-header-btn sr-header-btn-gold" data-role="dashboard-link" style="display:none;">
            Dashboard
          </a>
          <button type="button" class="sr-icon-btn sr-cart-btn drawer-cart" data-role="cart-button">
            üõí
            <span class="cart-count-badge" data-role="cart-count" style="display:none;"></span>
          </button>
        </div>

        <!-- MAIN CATEGORY LIST VIEW -->
        <div class="drawer-view drawer-view-main" id="drawer-view-main">
          <div class="drawer-section">
            <button type="button" class="drawer-link" data-cat="all" data-cat-link>
              All products
            </button>
          </div>
          <div class="drawer-section" id="nav-drawer-cat-list">
            <!-- main categories injected here -->
          </div>
        </div>

        <!-- SUBCATEGORY VIEW -->
        <div class="drawer-view drawer-view-subcats" id="drawer-view-subcats" style="display:none;">
          <div class="drawer-section drawer-subcats-header">
            <button type="button" class="drawer-back" id="drawer-subcats-back">‚Äπ Back</button>
            <span id="drawer-subcats-title"></span>
          </div>
          <div class="drawer-section" id="drawer-subcats-list">
            <!-- subcategories for chosen cat -->
          </div>
        </div>
      </div>
    </aside>
  </div>

  <!-- MAIN CONTENT -->
  <main class="sr-container">
    <div class="marketplace-layout">

      <!-- ===== Filters Sidebar ===== -->
      <aside class="filters-column">
        <div class="filters-title-main">Filters</div>

        <div class="filters-block" id="filters-tags-block">
          <div class="filters-block-title">Tags</div>
          <button class="filter-tag" data-tag="vrchat">vrchat</button>
          <button class="filter-tag" data-tag="notion template">notion template</button>
          <button class="filter-tag" data-tag="vrchat asset">vrchat asset</button>
          <button class="filter-tag" data-tag="free">free</button>
          <button class="filter-tag" data-tag="blender">blender</button>
          <!-- more tags can be added later -->
        </div>

        <div class="filters-block" id="filters-filetypes-block">
          <div class="filters-block-title">Contains</div>
          <button class="filter-filetype" data-type="pdf">pdf</button>
          <button class="filter-filetype" data-type="zip">zip</button>
          <button class="filter-filetype" data-type="mp4">mp4</button>
          <button class="filter-filetype" data-type="rar">rar</button>
          <button class="filter-filetype" data-type="mp3">mp3</button>
          <!-- more filetypes can be added later -->
        </div>

        <div class="filters-block">
          <div class="filters-block-title">Price</div>
          <div class="filters-input-row">
            <label for="price-min">Minimum price</label>
            <input
              id="price-min"
              type="number"
              min="0"
              step="1"
              inputmode="numeric"
              pattern="[0-9]*"
              placeholder="0">
          </div>
          <div class="filters-input-row">
            <label for="price-max">Maximum price</label>
            <input
              id="price-max"
              type="number"
              min="0"
              step="1"
              inputmode="numeric"
              pattern="[0-9]*"
              placeholder="‚àû">
          </div>
        </div>

        <div class="filters-block filters-rating">
          <div class="filters-block-title">Rating</div>
          <label><input type="radio" name="rating-min" value="4"> ‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ and up</label>
          <label><input type="radio" name="rating-min" value="3"> ‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ and up</label>
          <label><input type="radio" name="rating-min" value="2"> ‚òÖ‚òÖ‚òÜ‚òÜ‚òÜ and up</label>
          <label><input type="radio" name="rating-min" value="1"> ‚òÖ‚òÜ‚òÜ‚òÜ‚òÜ and up</label>
          <label><input type="radio" name="rating-min" value=""> Any rating</label>
        </div>

        <div class="filters-footer">
          <button class="filters-clear-btn" id="filters-clear">Clear filters</button>
        </div>
      </aside>

      <!-- ===== Right Content Column ===== -->
      <div class="content-column">

        <!-- MOBILE FILTERS BUTTON -->
        <button type="button" class="filters-toggle-btn" id="filters-toggle">
          Filters
        </button>

        <!-- Featured -->
        <section class="featured-section" id="featured-section">
          <div class="featured-header">
            <div class="featured-title" id="featured-title">Featured products</div>
            <div class="featured-controls">
              <button class="featured-btn" data-dir="left">‚Äπ</button>
              <button class="featured-btn" data-dir="right">‚Ä∫</button>
            </div>
          </div>
          <div class="featured-track" id="featured-track"></div>
          <div class="empty-text" id="featured-empty" style="display:none;">
            No featured products yet.
          </div>
        </section>

        <!-- Products grid -->
        <section class="products-section">
          <div class="products-header">
            <div class="products-title" id="products-title">All products</div>
          </div>
          <div class="products-grid" id="products-grid"></div>
          <div class="empty-text" id="products-empty" style="display:none;">
            No products found in this category yet.
          </div>
        </section>
      </div>
    </div>
  </main>

  <!-- FOOTER -->
  <div id="footer-root"></div>

    <!-- MAIN MARKETPLACE LOGIC -->
  <script>
    const SUPABASE_URL = "https://paqvgsruppgadgguynde.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBhcXZnc3J1cHBnYWRnZ3V5bmRlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzNTg3NTMsImV4cCI6MjA3NzkzNDc1M30.pwEE4WLFu2-tHkmH1fFYYwcEPmLPyavN7ykXdPGQ3AY";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const filterState = {
      tag: null,
      fileType: null,
      priceMin: null,
      priceMax: null,
      ratingMin: null
    };

    const PRIMARY_DESKTOP_CATS = [
      "3d",
      "roblox",
      "crafts",
      "design",
      "drawing-and-painting",
      "music-and-sound-design",
      "films"
    ];

    let currentSearchTerm = "";

    // --------- URL + headings ---------
    function getParamsFromUrl() {
      const params = new URLSearchParams(window.location.search);
      let catSlug = params.get("cat");
      let subSlug = params.get("sub");
      const searchTerm = (params.get("q") || "").trim();
      if (catSlug === "all") catSlug = null;
      return { catSlug, subSlug, searchTerm };
    }

    function formatHeading(catSlug, subSlug, searchTerm) {
      if (searchTerm && !catSlug && !subSlug) {
        return `Search: "${searchTerm}"`;
      }
      if (!catSlug && !subSlug) return "All products";
      const unslug = (s) => s.replace(/-/g, " ").replace(/\b\w/g, c => c.toUpperCase());
      if (catSlug && !subSlug) return unslug(catSlug);
      if (catSlug && subSlug) return unslug(catSlug) + " / " + unslug(subSlug);
      return "Products";
    }

    // nav active state
    let navState = {
      allButton: null,
      catButtons: {}, // slug -> element
      moreButton: null
    };

    function updateNavActive(catSlug) {
      if (!navState.allButton) return;

      Object.values(navState.catButtons).forEach(btn => btn.classList.remove("active"));
      if (navState.moreButton) navState.moreButton.classList.remove("active");
      navState.allButton.classList.remove("active");

      if (!catSlug) {
        navState.allButton.classList.add("active");
        return;
      }

      if (navState.catButtons[catSlug]) {
        navState.catButtons[catSlug].classList.add("active");
      } else if (navState.moreButton) {
        navState.moreButton.classList.add("active");
      }
    }

    // --------- seller, rating, price helpers ---------
    function formatSellerDisplay(name, plan) {
      if (!name) name = "Unknown seller";
      if (plan === "PRO") {
        return `${name} <span class="seller-badge-pro">[ ‚òÖ PRO ]</span>`;
      }
      if (plan === "ULTIMATE") {
        return `${name} <span class="seller-badge-ultimate">[ üëë ULTIMATE ]</span>`;
      }
      return name;
    }

    function buildRatingHtml(avg, count) {
      if (!avg || !count || count <= 0) return "";
      const score = Number(avg).toFixed(1);
      return `
        <div class="product-rating">
          <span class="star">‚òÖ</span>
          <span>${score}</span>
          <span>(${count})</span>
        </div>
      `;
    }

    function formatPrice(price) {
      if (typeof price === "number") {
        return "US$" + price.toFixed(2);
      }
      if (price === null || price === undefined) return "US$0.00";
      const n = Number(price);
      if (isNaN(n)) return "US$0.00";
      return "US$" + n.toFixed(2);
    }

    // --------- product card builders ---------
    function buildProductCard(product) {
      const ratingHtml = buildRatingHtml(product.rating_avg, product.rating_count);
      const sellerHtml = formatSellerDisplay(product.seller_name, product.seller_plan);
      const priceText = formatPrice(product.price);
      const cover = product.cover_url || "/placeholder-product.png";
      const productUrl = `/product.html?slug=${encodeURIComponent(product.slug || product.id)}`;
      return `
        <a href="${productUrl}" class="product-card">
          <div class="product-thumb">
            <img src="${cover}" alt="${product.title || "Product"}">
          </div>
          <div class="product-body">
            <div class="product-title">${product.title || "Untitled product"}</div>
            <div class="product-seller">${sellerHtml}</div>
            ${ratingHtml}
            <div class="product-footer">
              <div class="product-price">${priceText}</div>
              <div class="product-cta">View</div>
            </div>
          </div>
        </a>
      `;
    }

    function buildFeaturedCard(product) {
      const priceText = formatPrice(product.price);
      const sellerHtml = formatSellerDisplay(product.seller_name, product.seller_plan);
      const cover = product.cover_url || "/placeholder-product.png";
      const productUrl = `/product.html?slug=${encodeURIComponent(product.slug || product.id)}`;
      return `
        <a href="${productUrl}" class="featured-card">
          <div class="featured-thumb">
            <img src="${cover}" alt="${product.title || "Product"}">
          </div>
          <div class="featured-body">
            <div class="featured-title-text">${product.title || "Untitled product"}</div>
            <div class="featured-meta">${sellerHtml}</div>
            <div class="featured-price">${priceText}</div>
          </div>
        </a>
      `;
    }

    // --------- filters ---------
    function applyFiltersToQuery(query) {
      if (filterState.tag) {
        query = query.contains("tags", [filterState.tag]);
      }
      if (filterState.fileType) {
        query = query.contains("file_types", [filterState.fileType]);
      }
      if (filterState.priceMin !== null && filterState.priceMin !== "") {
        query = query.gte("price", filterState.priceMin);
      }
      if (filterState.priceMax !== null && filterState.priceMax !== "") {
        query = query.lte("price", filterState.priceMax);
      }
      if (filterState.ratingMin !== null && filterState.ratingMin !== "") {
        query = query.gte("rating_avg", filterState.ratingMin);
      }
      return query;
    }

    function setupShowMore(containerSelector, itemSelector) {
      const container = document.querySelector(containerSelector);
      if (!container) return;
      const items = Array.from(container.querySelectorAll(itemSelector));
      if (items.length <= 5) return;

      items.forEach((item, index) => {
        if (index >= 5) item.classList.add("filter-hidden");
      });

      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "filter-show-more";
      btn.textContent = "Show more";
      let expanded = false;

      btn.addEventListener("click", () => {
        expanded = !expanded;
        if (expanded) {
          items.forEach(i => i.classList.remove("filter-hidden"));
          btn.textContent = "Show less";
        } else {
          items.forEach((item, index) => {
            if (index >= 5) item.classList.add("filter-hidden");
          });
          btn.textContent = "Show more";
        }
      });

      container.appendChild(btn);
    }

    function initFilterEvents(reloadFn) {
      // tag show-more + filetype show-more
      setupShowMore("#filters-tags-block", ".filter-tag");
      setupShowMore("#filters-filetypes-block", ".filter-filetype");

      document.querySelectorAll(".filter-tag").forEach(btn => {
        btn.addEventListener("click", () => {
          const tag = btn.getAttribute("data-tag");
          if (!tag) return;
          if (filterState.tag === tag) {
            filterState.tag = null;
            btn.classList.remove("active");
          } else {
            filterState.tag = tag;
            document.querySelectorAll(".filter-tag").forEach(b => b.classList.remove("active"));
            btn.classList.add("active");
          }
          reloadFn();
        });
      });

      document.querySelectorAll(".filter-filetype").forEach(btn => {
        btn.addEventListener("click", () => {
          const t = btn.getAttribute("data-type");
          if (filterState.fileType === t) {
            filterState.fileType = null;
            btn.classList.remove("active");
          } else {
            filterState.fileType = t;
            document.querySelectorAll(".filter-filetype").forEach(b => b.classList.remove("active"));
            btn.classList.add("active");
          }
          reloadFn();
        });
      });

      const priceMinInput = document.getElementById("price-min");
      const priceMaxInput = document.getElementById("price-max");

      priceMinInput.addEventListener("change", () => {
        const v = priceMinInput.value;
        const parsed = v === "" ? null : Math.max(0, parseInt(v, 10) || 0);
        priceMinInput.value = parsed === null ? "" : parsed;
        filterState.priceMin = parsed;
        reloadFn();
      });

      priceMaxInput.addEventListener("change", () => {
        const v = priceMaxInput.value;
        const parsed = v === "" ? null : Math.max(0, parseInt(v, 10) || 0);
        priceMaxInput.value = parsed === null ? "" : parsed;
        filterState.priceMax = parsed;
        reloadFn();
      });

      document.querySelectorAll("input[name='rating-min']").forEach(radio => {
        radio.addEventListener("change", () => {
          const v = radio.value;
          filterState.ratingMin = v === "" ? null : parseFloat(v);
          reloadFn();
        });
      });

      document.getElementById("filters-clear").addEventListener("click", () => {
        filterState.tag = null;
        filterState.fileType = null;
        filterState.priceMin = null;
        filterState.priceMax = null;
        filterState.ratingMin = null;
        document.querySelectorAll(".filter-tag, .filter-filetype").forEach(b => b.classList.remove("active"));
        priceMinInput.value = "";
        priceMaxInput.value = "";
        document.querySelectorAll("input[name='rating-min']").forEach(r => r.checked = false);
        reloadFn();
      });
    }

    // --------- data loading ---------
    async function loadFeaturedProducts(catSlug, subSlug) {
      const track = document.getElementById("featured-track");
      const empty = document.getElementById("featured-empty");
      track.innerHTML = "";
      empty.style.display = "none";

      let query = supabase
        .from("products")
        .select("id, slug, title, price, cover_url, seller_name, seller_plan, rating_avg, rating_count, category_slug, subcategory_slug, is_featured, is_active")
        .eq("is_active", true)
        .eq("is_featured", true)
        .limit(10);

      if (catSlug) query = query.eq("category_slug", catSlug);
      if (subSlug) query = query.eq("subcategory_slug", subSlug);
      if (currentSearchTerm) {
        query = query.ilike("title", `%${currentSearchTerm}%`);
      }

      query = applyFiltersToQuery(query);

      const { data, error } = await query;
      if (error) {
        console.error("Error loading featured products", error);
        empty.textContent = "Failed to load featured products.";
        empty.style.display = "block";
        return;
      }

      if (!data || data.length === 0) {
        empty.style.display = "block";
        return;
      }

      data.forEach(p => {
        track.insertAdjacentHTML("beforeend", buildFeaturedCard(p));
      });
    }

    async function loadProductsGrid(catSlug, subSlug) {
      const grid = document.getElementById("products-grid");
      const empty = document.getElementById("products-empty");
      grid.innerHTML = "";
      empty.style.display = "none";

      let query = supabase
        .from("products")
        .select("id, slug, title, price, cover_url, seller_name, seller_plan, rating_avg, rating_count, category_slug, subcategory_slug, is_active")
        .eq("is_active", true);

      if (catSlug) query = query.eq("category_slug", catSlug);
      if (subSlug) query = query.eq("subcategory_slug", subSlug);
      if (currentSearchTerm) {
        query = query.ilike("title", `%${currentSearchTerm}%`);
      }

      query = applyFiltersToQuery(query);

      const { data, error } = await query;
      if (error) {
        console.error("Error loading products", error);
        empty.textContent = "Failed to load products.";
        empty.style.display = "block";
        return;
      }

      if (!data || data.length === 0) {
        empty.style.display = "block";
        return;
      }

      data.forEach(p => {
        grid.insertAdjacentHTML("beforeend", buildProductCard(p));
      });
    }

    // --------- featured slider ---------
    function initFeaturedSlider() {
      const track = document.getElementById("featured-track");
      if (!track) return;
      const buttons = document.querySelectorAll(".featured-btn");
      buttons.forEach(btn => {
        btn.addEventListener("click", () => {
          const dir = btn.getAttribute("data-dir");
          const amount = 220;
          track.scrollBy({
            left: dir === "left" ? -amount : amount,
            behavior: "smooth"
          });
        });
      });
    }

    // --------- header auth + cart ---------
    function getCartCount() {
      try {
        const raw = localStorage.getItem("sr_cart_items");
        if (!raw) return 0;
        const arr = JSON.parse(raw);
        if (Array.isArray(arr)) return arr.length;
        return 0;
      } catch {
        return 0;
      }
    }

    function updateCartCount() {
      const count = getCartCount();
      document.querySelectorAll('[data-role="cart-count"]').forEach(span => {
        if (count > 0) {
          span.textContent = count;
          span.style.display = "inline-block";
        } else {
          span.textContent = "";
          span.style.display = "none";
        }
      });
    }

    function applyAuthState(loggedIn) {
      document.querySelectorAll('[data-role="login-link"]').forEach(el => {
        el.style.display = loggedIn ? "none" : "";
      });
      document.querySelectorAll('[data-role="start-link"]').forEach(el => {
        el.style.display = loggedIn ? "none" : "";
      });
      document.querySelectorAll('[data-role="library-link"]').forEach(el => {
        el.style.display = loggedIn ? "" : "none";
      });
      document.querySelectorAll('[data-role="dashboard-link"]').forEach(el => {
        el.style.display = loggedIn ? "" : "none";
      });
    }

    async function initHeaderAuthAndCart() {
      try {
        const { data } = await supabase.auth.getSession();
        applyAuthState(!!data.session);

        supabase.auth.onAuthStateChange((_event, session) => {
          applyAuthState(!!session);
        });
      } catch (err) {
        console.error("Auth state error", err);
      }

      document.querySelectorAll('[data-role="cart-button"]').forEach(btn => {
        btn.addEventListener("click", () => {
          window.location.href = "/checkout.html";
        });
      });

      updateCartCount();
    }

    // --------- CATEGORY NAV FROM SUPABASE ---------
    let drawerCatMap = {}; // slug -> { name, subs: [ {slug,name} ] }

    async function buildCategoryNav(catSlug) {
      const desktopScroll = document.getElementById("desktop-cat-scroll");
      const drawerCatList = document.getElementById("nav-drawer-cat-list");
      if (!desktopScroll || !drawerCatList) return;

      desktopScroll.innerHTML = "";
      drawerCatList.innerHTML = "";

      // All button (desktop)
      const allItem = document.createElement("div");
      allItem.className = "nav-cat-item";
      const allBtn = document.createElement("a");
      allBtn.href = "/marketplace.html";
      allBtn.textContent = "All";
      allBtn.className = "nav-pill";
      navState.allButton = allBtn;
      allItem.appendChild(allBtn);
      desktopScroll.appendChild(allItem);

      // fetch categories + subcategories
      const { data: cats, error: catErr } = await supabase
        .from("categories")
        .select("id, slug, name, sort_order")
        .order("sort_order", { ascending: true });

      if (catErr) {
        console.error("Error loading categories", catErr);
        return;
      }

      const { data: subs, error: subErr } = await supabase
        .from("subcategories")
        .select("id, category_id, slug, name, sort_order")
        .order("sort_order", { ascending: true });

      if (subErr) {
        console.error("Error loading subcategories", subErr);
        return;
      }

      const subsByCatId = {};
      (subs || []).forEach(sc => {
        if (!subsByCatId[sc.category_id]) subsByCatId[sc.category_id] = [];
        subsByCatId[sc.category_id].push(sc);
      });

      drawerCatMap = {};

      const primary = [];
      const more = [];

      (cats || []).forEach(c => {
        const entry = {
          id: c.id,
          slug: c.slug,
          name: c.name,
          subs: subsByCatId[c.id] || []
        };
        drawerCatMap[c.slug] = {
          name: c.name,
          subs: entry.subs
        };

        if (PRIMARY_DESKTOP_CATS.includes(c.slug)) {
          primary.push(entry);
        } else {
          more.push(entry);
        }
      });

      // desktop primary categories
      primary.forEach(cat => {
        const item = document.createElement("div");
        item.className = "nav-cat-item has-menu";
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "nav-pill nav-cat-trigger";
        btn.textContent = cat.name;
        btn.dataset.cat = cat.slug;
        navState.catButtons[cat.slug] = btn;

        btn.addEventListener("click", () => {
          window.location.href = `/marketplace.html?cat=${encodeURIComponent(cat.slug)}`;
        });

        const menu = document.createElement("div");
        menu.className = "nav-cat-menu";
        if (cat.subs.length > 0) {
          cat.subs.forEach(sc => {
            const a = document.createElement("a");
            a.href = `/marketplace.html?cat=${encodeURIComponent(cat.slug)}&sub=${encodeURIComponent(sc.slug)}`;
            a.textContent = sc.name;
            menu.appendChild(a);
          });
        } else {
          const a = document.createElement("a");
          a.href = `/marketplace.html?cat=${encodeURIComponent(cat.slug)}`;
          a.textContent = `View all ${cat.name}`;
          menu.appendChild(a);
        }

        item.appendChild(btn);
        item.appendChild(menu);
        desktopScroll.appendChild(item);
      });

      // desktop MORE menu
      if (more.length > 0) {
        const moreItem = document.createElement("div");
        moreItem.className = "nav-more";
        const moreBtn = document.createElement("button");
        moreBtn.type = "button";
        moreBtn.className = "nav-pill nav-more-toggle";
        moreBtn.textContent = "More ‚ñæ";
        navState.moreButton = moreBtn;

        const dropdown = document.createElement("div");
        dropdown.className = "nav-more-dropdown";

        more.forEach(cat => {
          const groupTitle = document.createElement("div");
          groupTitle.className = "more-group-title";
          groupTitle.textContent = cat.name;
          dropdown.appendChild(groupTitle);

          if (cat.subs.length > 0) {
            cat.subs.forEach(sc => {
              const a = document.createElement("a");
              a.className = "more-link";
              a.href = `/marketplace.html?cat=${encodeURIComponent(cat.slug)}&sub=${encodeURIComponent(sc.slug)}`;
              a.textContent = sc.name;
              dropdown.appendChild(a);
            });
          } else {
            const a = document.createElement("a");
            a.className = "more-link";
            a.href = `/marketplace.html?cat=${encodeURIComponent(cat.slug)}`;
            a.textContent = `All ${cat.name}`;
            dropdown.appendChild(a);
          }
        });

        moreItem.appendChild(moreBtn);
        moreItem.appendChild(dropdown);
        desktopScroll.appendChild(moreItem);

        let hideTimeout;
        const open = () => {
          dropdown.classList.add("open");
        };
        const close = () => {
          dropdown.classList.remove("open");
        };
        moreItem.addEventListener("mouseenter", () => {
          clearTimeout(hideTimeout);
          open();
        });
        moreItem.addEventListener("mouseleave", () => {
          hideTimeout = setTimeout(close, 150);
        });
      }

      // MOBILE drawer categories (all cats)
      const allCatsForDrawer = [...primary, ...more];
      allCatsForDrawer.forEach(cat => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "drawer-link drawer-link-cat";
        btn.dataset.catSlug = cat.slug;
        btn.textContent = `${cat.name} ‚Ä∫`;
        drawerCatList.appendChild(btn);
      });
    }

    // --------- mobile nav drawer behavior ---------
    function initNavDrawer() {
      const toggle = document.getElementById("nav-drawer-toggle");
      const backdrop = document.getElementById("nav-drawer-backdrop");
      const drawer = document.getElementById("nav-drawer");
      const closeBtn = document.getElementById("nav-drawer-close");
      const backBtn = document.getElementById("drawer-subcats-back");
      const viewMain = document.getElementById("drawer-view-main");
      const viewSubs = document.getElementById("drawer-view-subcats");
      const subsTitle = document.getElementById("drawer-subcats-title");
      const subsList = document.getElementById("drawer-subcats-list");

      if (!toggle || !backdrop || !drawer) return;

      function openDrawer() {
        backdrop.classList.add("open");
      }
      function closeDrawer() {
        backdrop.classList.remove("open");
        viewMain.style.display = "";
        viewSubs.style.display = "none";
      }

      toggle.addEventListener("click", openDrawer);
      closeBtn.addEventListener("click", closeDrawer);
      backdrop.addEventListener("click", (e) => {
        if (e.target === backdrop) closeDrawer();
      });

      backBtn.addEventListener("click", () => {
        viewMain.style.display = "";
        viewSubs.style.display = "none";
      });

      document.getElementById("nav-drawer-cat-list").addEventListener("click", (e) => {
        const btn = e.target.closest(".drawer-link-cat");
        if (!btn) return;
        const slug = btn.dataset.catSlug;
        const catEntry = drawerCatMap[slug];
        if (!catEntry) return;

        subsTitle.textContent = catEntry.name;
        subsList.innerHTML = "";

        const allLink = document.createElement("a");
        allLink.className = "drawer-link";
        allLink.href = `/marketplace.html?cat=${encodeURIComponent(slug)}`;
        allLink.textContent = `All ${catEntry.name}`;
        subsList.appendChild(allLink);

        (catEntry.subs || []).forEach(sc => {
          const a = document.createElement("a");
          a.className = "drawer-link";
          a.href = `/marketplace.html?cat=${encodeURIComponent(slug)}&sub=${encodeURIComponent(sc.slug)}`;
          a.textContent = sc.name;
          subsList.appendChild(a);
        });

        viewMain.style.display = "none";
        viewSubs.style.display = "";
      });

      // "All products" button at top of drawer
      document.querySelectorAll("[data-cat-link][data-cat='all']").forEach(btn => {
        btn.addEventListener("click", () => {
          window.location.href = "/marketplace.html";
        });
      });
    }

    // --------- filters drawer (mobile) ---------
    function initFiltersDrawer() {
      const toggle = document.getElementById("filters-toggle");
      if (!toggle) return;

      const overlay = document.createElement("div");
      overlay.className = "filters-overlay";
      document.body.appendChild(overlay);

      function openFilters() {
        document.body.classList.add("filters-open");
      }
      function closeFilters() {
        document.body.classList.remove("filters-open");
      }

      toggle.addEventListener("click", openFilters);
      overlay.addEventListener("click", closeFilters);
    }

    // --------- search clear button ---------
    function initSearchClear() {
      const input = document.querySelector(".sr-search-input");
      const clearBtn = document.querySelector(".sr-search-clear");
      if (!input || !clearBtn) return;

      function syncClear() {
        if (input.value && input.value.length > 0) {
          clearBtn.style.display = "block";
        } else {
          clearBtn.style.display = "none";
        }
      }

      input.addEventListener("input", syncClear);
      clearBtn.addEventListener("click", () => {
        input.value = "";
        syncClear();
        input.focus();
      });

      syncClear();
    }

    // --------- init ---------
    async function initMarketplace() {
      const { catSlug, subSlug, searchTerm } = getParamsFromUrl();
      currentSearchTerm = searchTerm;

      const heading = formatHeading(catSlug, subSlug, searchTerm);
      document.getElementById("products-title").textContent = heading;
      document.getElementById("featured-title").textContent =
        (catSlug || subSlug || searchTerm) ? ("Featured in " + heading) : "Featured products";

      const searchInput = document.querySelector(".sr-search-input");
      if (searchInput && searchTerm) {
        searchInput.value = searchTerm;
      }

      await buildCategoryNav(catSlug);
      updateNavActive(catSlug);

      initFeaturedSlider();
      initNavDrawer();
      initFiltersDrawer();
      await initHeaderAuthAndCart();
      initSearchClear();

      const reloadAll = () => {
        loadFeaturedProducts(catSlug, subSlug);
        loadProductsGrid(catSlug, subSlug);
      };

      initFilterEvents(reloadAll);
      reloadAll();
    }

    document.addEventListener("DOMContentLoaded", initMarketplace);
  </script>

  <!-- Footer loader -->
  <script type="module" src="/js/footer.js"></script>
</body>
</html>

